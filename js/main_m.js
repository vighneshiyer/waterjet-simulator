$(window).load(function(){var e=document.getElementById("header").offsetHeight;$("#wrapper").css("top",e)}),$(document).ready(function(){function e(e,t){var n="";for(var r=e;r>0;--r)n+=t[Math.round(Math.random()*(t.length-1))];return n}function n(){$("#execute").show(),$("#reset_defaults").css("marginLeft","10px")}function r(){$("#execute").hide(),$("#reset_defaults").css("margin","0")}function a(e){i.length=0,$.each(e.output,function(e,t){i.push([e/1e6,t])}),u={data:i,color:"rgb(200,0,0)",label:"Pressure vs. Energy Flux"},o=$.plot($("#pressure_flux_graph"),[u],s),console.log(i)}function f(e,t,n){$('<div id="tooltip">'+n+"</div>").css({position:"absolute",display:"none",top:t+7,left:e+7,border:"1px solid #fdd",padding:"2px","background-color":"#fff",opacity:.8}).appendTo("body").fadeIn(200)}function c(e){var t=$(e).parent().children(".formfield").attr("data");$(e).parent().children(".formfield").val(t).siblings("span").remove()}function h(){$("#PRESSURE_MIN").val($("#PRESSURE_MIN").attr("data")),$("#PRESSURE_MAX").val($("#PRESSURE_MAX").attr("data"))}function D(){g=new THREE.Scene;var e=$("#draw_box").width(),t=$("#draw_box").height();v=new THREE.PerspectiveCamera(45,e/t,.1,1e4),v.position.z=500,v.position.y=500,g.add(v),y=new THREE.WebGLRenderer({antialias:!0,precision:"highp"}),y.setSize(e,t),m=new THREE.TrackballControls(v,y.domElement),m.target.set=(0,300,0),m.rotateSpeed=1,m.zoomSpeed=1.2,m.panSpeed=.8,m.noRotate=!1,m.noZoom=!1,m.noPan=!1,m.staticMoving=!0,m.dynamicDampingFactor=.3,m.keys[82,90,80],m.addEventListener("change",H),T=Math.ceil($("#TUBE_LENGTH").val()*_),N=Math.ceil($("#TUBE_DIAMETER").val()*_),C=Math.ceil($("#MIXING_CHAMBER_DIAMETER").val()*_),k=Math.ceil($("#MIXING_CHAMBER_LENGTH").val()*_),L=Math.ceil($("#PIPE_LENGTH").val()*_),A=Math.ceil($("#PIPE_DIAMETER").val()*_),O=Math.ceil($("#NOZZLE_DIAMETER").val()*_),M=.01*_;var n=new THREE.MeshLambertMaterial({color:16711680}),r=new THREE.MeshLambertMaterial({color:65280}),i=new THREE.MeshLambertMaterial({color:8947848}),s=new THREE.MeshLambertMaterial({color:255});w=new THREE.Mesh(new THREE.CylinderGeometry(N,N,T,1e3),n),w.geometry.dynamic=!0,w.geometry.verticesNeedUpdate=!0,w.geometry.normalsNeedUpdate=!0,E=new THREE.Mesh(new THREE.CylinderGeometry(C,C,k,1e3),r),E.geometry.dynamic=!0,E.geometry.verticesNeedUpdate=!0,E.geometry.normalsNeedUpdate=!0,E.position.y=T/2+k/2,S=new THREE.Mesh(new THREE.CylinderGeometry(O,O,M,1e3),i),S.geometry.dynamic=!0,S.geometry.verticesNeedUpdate=!0,S.geometry.normalsNeedUpdate=!0,S.position.y=T/2+k+M/2,x=new THREE.Mesh(new THREE.CylinderGeometry(A,A,L,1e3),s),x.rotation.z=Math.PI/2,x.geometry.dynamic=!0,x.geometry.verticesNeedUpdate=!0,x.geometry.normalsNeedUpdate=!0,x.position.y=T/2+k/2,x.position.x=L/2+C,g.add(w),g.add(E),g.add(S),g.add(x),b=new THREE.DirectionalLight(16777215),b.position.set(1,1,1),g.add(b),b=new THREE.DirectionalLight(16777215),b.position.set(-1,-1,-1),g.add(b),b=new THREE.DirectionalLight(16777215),b.position.set(-1,1,1),g.add(b),b=new THREE.DirectionalLight(16777215),b.position.set(1,1,-1),g.add(b),p.empty(),p.append(y.domElement)}function P(){requestAnimFrame(P),m.update()}function H(){y.render(g,v)}$("input").focus(function(){this.select()}),$("#result").resize(function(){var e=document.getElementById("header").offsetHeight;$("#wrapper").css("top",e)}),$(".formitem").hover(function(){$(this).addClass("formfield_hover")},function(){$(this).removeClass("formfield_hover")}),$("#result_progressbar").progressbar({value:0}),$("#top_bar_help").leanModal({top:200,overlay:.7,closeButton:".modal_close"}),$(".formfield").each(function(e,t){var n=this.id,r=new LiveValidation(n,{validMessage:" "});r.add(Validate.Presence,{failureMessage:" "}),r.add(Validate.Numericality,{minimum:0,failureMessage:" ",notANumberMessage:" ",tooLowMessage:" "})}),$.ajaxSetup({cache:!1});var t="run_program.php";$("#execute").click(function(i){function h(){$.post("progress_poller.php",{progress_file_id:l},function(e){$("#result_progressbar").progressbar("value",parseInt(e,10))}),c=setTimeout(h,1e3)}r(),$("#result_progressbar").progressbar("value",0),i.preventDefault(),$("#result_text").empty(),$("#result_text").html("Calculating energy flux..."),$("#csv_download").css("display","none"),$("#csv_download").attr("onClick","");var s=$("#input_form .formfield").serialize(),o=$("#PRESSURE_MIN").val().toString(),u=$("#PRESSURE_MAX").val().toString(),f=$("#INTERVAL").val().toString(),l=e(32,"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"),c;$.post(t,{f_data:s,min_pressure:o,max_pressure:u,interval:f,progress_id:l},function(e){$("#result_progressbar").progressbar("value",100),clearTimeout(c);try{var t=jQuery.parseJSON(e)}catch(r){return alert("Internal problem. If this message took 1 minute to pop up since clicking Calculate the script timed out. Try again with a larger interval."),n(),$("#result_text").empty(),!1}finally{$.get("deleter.php",{progress_id:l,number:t.number})}n(),$("#result_text").html(t.message),a(t),$("#csv_download").css("display","inline"),$("#csv_download").attr("onClick","window.location.href = '"+t.csv_url+"'")}),h()});var i=[],s={series:{lines:{show:!0},points:{show:!0}},xaxes:[{axisLabel:"Pressure (MPa)"}],yaxes:[{axisLabel:"Energy Flux (W)"}],grid:{hoverable:!0},zoom:{interactive:!0},pan:{interactive:!0}},o=$.plot($("#pressure_flux_graph"),[i],s),u;$("#graph_reset").click(function(){o=$.plot($("#pressure_flux_graph"),[u],s)});var l=null;$("#pressure_flux_graph").bind("plothover",function(e,t,n){$("#x").text(t.x.toFixed(2)),$("#y").text(t.y.toFixed(2));if(n){if(l!=n.dataIndex){l=n.dataIndex,$("#tooltip").remove();var r=n.datapoint[0].toFixed(2),i=n.datapoint[1].toFixed(2);f(n.pageX,n.pageY,r+" MPa, "+i+" W")}}else $("#tooltip").remove(),l=null}),$("#PRESSURE_LABEL").click(function(){h()}),$("#INTERVAL_LABEL").click(function(){$("#INTERVAL").val($("#INTERVAL").attr("data"))}),$("label").click(function(e){c(this)}),$("#reset_defaults").click(function(e){e.preventDefault(),$("label").each(function(e,t){c(this)}),h(),$("#INTERVAL").val($("#INTERVAL").attr("data"))});var p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M;p=$("#draw_box"),d=document.getElementById("draw_box");var _=4e3;D(),P(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),$(".geofield").blur(function(){D()});var B=!1;$("#draw_expand_button").click(function(){B===!1?($("html").css("height","100%"),$("body").css("height","100%"),$("#col2").addClass("col2_expand"),$("#col1").addClass("col1_expand"),$("#draw_controls").addClass("draw_controls_expand"),$("#wrapper").addClass("wrapper_expand"),$("#draw_box").addClass("draw_box_expand"),$("#draw_expand_button").attr("title","Contract model"),$("#header").css("display","none"),D(),P(),B=!0):B===!0&&($("html").css("height","auto"),$("body").css("height","auto"),$("#col2").removeClass("col2_expand"),$("#col1").removeClass("col1_expand"),$("#draw_controls").removeClass("draw_controls_expand"),$("#wrapper").removeClass("wrapper_expand"),$("#draw_box").removeClass("draw_box_expand"),$("#draw_expand_button").attr("title","Expand model"),$("#header").css("display","block"),D(),P(),B=!1)}),$("#draw_reset_button").click(function(){D()})})